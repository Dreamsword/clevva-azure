{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "webAppName": {
      "type": "string",
      "defaultValue": "Clevva-Web-App",
      "metadata": {
        "description": "Base name of the resource such as Clevva-Web-App."
      },
      "minLength": 2
    },
    "DatabaseUser": {
      "type": "string",
      "defaultValue": "clevvapro",
      "metadata": {
        "description": "Name of the database user."
      },
      "minLength": 4
    },
    "DatabasePassword": {
      "type": "string",
      "defaultValue": "clevvadatabasepasswordproduction",
      "metadata": {
        "description": "Password of the database user."
      },
      "minLength": 6
    },
    "DatabaseResources": {
      "type": "string",
      "allowedValues": [
        "GP_Gen5_4",
        "GP_Gen5_8",
        "GP_Gen5_16",
        "GP_Gen5_32",
        "GP_Gen5_64"
      ],
      "defaultValue": "GP_Gen5_4",
      "metadata": {
        "description": "The speed of the database (the number depects the number of vCPU's)."
      }
    },
    "Organization": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Name of your company."
      },
      "minLength": 3
    }
  },
  "variables": {
    "webAppPortalName": "[concat(parameters('webAppName'))]",
    "appServicePlanName": "[concat('AppServicePlan-', parameters('webAppName'))]",
    "databasePortalName": "[concat(parameters('webAppName'), '-database')]",
    "locationName": "[resourceGroup().location]",
    "linuxFxVersion": "php|7.4"
  },
  "resources": [
    {
      "type": "Microsoft.Web/serverfarms",
      "apiVersion": "2018-02-01",
      "name": "[variables('appServicePlanName')]",
      "location": "[variables('locationName')]",
      "sku": {
        "Tier": "Standard",
        "Name": "S1"
      },
      "kind": "linux",
      "properties": {
        "reserved": true
      }
    },
    {
        "type": "Microsoft.DBforMySQL/servers",
        "apiVersion": "2017-12-01",
        "name": "[variables('databasePortalName')]",
        "dependsOn": [
            "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]"
        ],
        "location": "[variables('locationName')]",
        "sku": {
            "name": "[parameters('DatabaseResources')]",
            "tier": "GeneralPurpose",
            "family": "Gen5",
            "capacity": 2
        },
        "properties": {
            "createMode": "Default",
            "version": "5.7",
            "administratorLogin": "[parameters('DatabaseUser')]",
            "administratorLoginPassword": "[parameters('DatabasePassword')]",
            "storageProfile": {
                "storageMB": 102400,
                "backupRetentionDays": 7,
                "geoRedundantBackup": "Disabled",
                "storageAutogrow": "Enabled"
            },
            "sslEnforcement": "Enabled",
            "minimalTlsVersion": "TLSEnforcementDisabled",
            "infrastructureEncryption": "Disabled",
            "publicNetworkAccess": "Enabled"
        }
    },
    {
        "type": "Microsoft.DBforMySQL/servers/configurations",
        "apiVersion": "2017-12-01",
        "name": "[concat(variables('databasePortalName'), '/character_set_server')]",
        "dependsOn": [
            "[resourceId('Microsoft.DBforMySQL/servers', variables('databasePortalName'))]"
        ],
        "properties": {
            "value": "UTF8MB4",
            "source": "user-override"
        }
    },
    {
        "type": "Microsoft.DBforMySQL/servers/configurations",
        "apiVersion": "2017-12-01",
        "name": "[concat(variables('databasePortalName'), '/collation_server')]",
        "dependsOn": [
            "[resourceId('Microsoft.DBforMySQL/servers', variables('databasePortalName'))]"
        ],
        "properties": {
            "value": "UTF8MB4_BIN",
            "source": "user-override"
        }
    },
    {
        "type": "Microsoft.DBforMySQL/servers/configurations",
        "apiVersion": "2017-12-01",
        "name": "[concat(variables('databasePortalName'), '/event_scheduler')]",
        "dependsOn": [
            "[resourceId('Microsoft.DBforMySQL/servers', variables('databasePortalName'))]"
        ],
        "properties": {
            "value": "ON",
            "source": "user-override"
        }
    },
    {
        "type": "Microsoft.DBforMySQL/servers/configurations",
        "apiVersion": "2017-12-01",
        "name": "[concat(variables('databasePortalName'), '/query_store_capture_mode')]",
        "dependsOn": [
            "[resourceId('Microsoft.DBforMySQL/servers', variables('databasePortalName'))]"
        ],
        "properties": {
            "value": "ALL",
            "source": "user-override"
        }
    },
    {
        "type": "Microsoft.DBforMySQL/servers/configurations",
        "apiVersion": "2017-12-01",
        "name": "[concat(variables('databasePortalName'), '/query_store_wait_sampling_capture_mode')]",
        "dependsOn": [
            "[resourceId('Microsoft.DBforMySQL/servers', variables('databasePortalName'))]"
        ],
        "properties": {
            "value": "ALL",
            "source": "user-override"
        }
    },
    {
        "type": "Microsoft.DBforMySQL/servers/databases",
        "apiVersion": "2017-12-01",
        "name": "[concat(variables('databasePortalName'), '/clevva')]",
        "dependsOn": [
            "[resourceId('Microsoft.DBforMySQL/servers', variables('databasePortalName'))]"
        ],
        "properties": {
            "charset": "utf8mb4",
            "collation": "utf8mb4_general_ci"
        }
    },
    {
        "type": "Microsoft.DBforMySQL/servers/databases",
        "apiVersion": "2017-12-01",
        "name": "[concat(variables('databasePortalName'), '/information_schema')]",
        "dependsOn": [
            "[resourceId('Microsoft.DBforMySQL/servers', variables('databasePortalName'))]"
        ],
        "properties": {
            "charset": "utf8",
            "collation": "utf8_general_ci"
        }
    },
    {
        "type": "Microsoft.DBforMySQL/servers/databases",
        "apiVersion": "2017-12-01",
        "name": "[concat(variables('databasePortalName'), '/mysql')]",
        "dependsOn": [
            "[resourceId('Microsoft.DBforMySQL/servers', variables('databasePortalName'))]"
        ],
        "properties": {
            "charset": "utf8",
            "collation": "utf8_general_ci"
        }
    },
    {
        "type": "Microsoft.DBforMySQL/servers/databases",
        "apiVersion": "2017-12-01",
        "name": "[concat(variables('databasePortalName'), '/performance_schema')]",
        "dependsOn": [
            "[resourceId('Microsoft.DBforMySQL/servers', variables('databasePortalName'))]"
        ],
        "properties": {
            "charset": "utf8",
            "collation": "utf8_general_ci"
        }
    },
    {
        "type": "Microsoft.DBforMySQL/servers/databases",
        "apiVersion": "2017-12-01",
        "name": "[concat(variables('databasePortalName'), '/sys')]",
        "dependsOn": [
            "[resourceId('Microsoft.DBforMySQL/servers', variables('databasePortalName'))]"
        ],
        "properties": {
            "charset": "utf8",
            "collation": "utf8_general_ci"
        }
    },
    {
        "type": "Microsoft.DBforMySQL/servers/firewallRules",
        "apiVersion": "2017-12-01",
        "name": "[concat(variables('databasePortalName'), '/AllowAllWindowsAzureIps')]",
        "dependsOn": [
            "[resourceId('Microsoft.DBforMySQL/servers', variables('databasePortalName'))]"
        ],
        "properties": {
            "startIpAddress": "0.0.0.0",
            "endIpAddress": "0.0.0.0"
        }
    },
    {
        "type": "Microsoft.DBforMySQL/servers/securityAlertPolicies",
        "apiVersion": "2017-12-01",
        "name": "[concat(variables('databasePortalName'), '/Default')]",
        "dependsOn": [
            "[resourceId('Microsoft.DBforMySQL/servers', variables('databasePortalName'))]"
        ],
        "properties": {
            "state": "Enabled",
            "disabledAlerts": [
                ""
            ],
            "emailAddresses": [
                "devops@clevva.com"
            ],
            "emailAccountAdmins": false,
            "retentionDays": 0
        }
    },
    {
      "type": "Microsoft.Web/sites",
      "apiVersion": "2018-02-01",
      "name": "[variables('webAppPortalName')]",
      "location": "[variables('locationName')]",
      "kind": "app,linux",
      "dependsOn": [
        "[resourceId('Microsoft.DBforMySQL/servers', variables('databasePortalName'))]"
      ],
      "properties": {
        "enabled": true,
        "httpsOnly": true,
        "reserved": true,
        "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]",
        "siteConfig": {
          "linuxFxVersion": "[variables('linuxFxVersion')]",
          "appSettings": [
            {
                "name": "DB_HOST",
                "value": "[concat(variables('databasePortalName'), '.mysql.database.azure.com')]"
            },
            {
                "name": "DB_USER",
                "value": "[parameters('DatabaseUser')]"
            },
            {
                "name": "DB_PASS",
                "value": "[parameters('DatabasePassword')]"
            },
            {
                "name": "DB_NAME",
                "value": "clevva"
            },
            {
                "name": "IS_HTTPS",
                "value": "true"
            },
            {
                "name": "MYSQL_ATTR_SSL_CA",
                "value": "/home/site/wwwroot/BaltimoreCyberTrustRoot.crt.pem"
            }
          ]
        }
      }
    },
    {
        "type": "Microsoft.Web/sites/config",
        "apiVersion": "2018-02-01",
        "name": "[concat(variables('webAppPortalName'), '/web')]",
        "location": "[variables('locationName')]",
        "dependsOn": [
            "[resourceId('Microsoft.Web/sites', variables('webAppPortalName'))]"
        ],
        "properties": {
            "numberOfWorkers": 1,
            "defaultDocuments": [
                "index.php"
            ],
            "netFrameworkVersion": "v4.0",
            "linuxFxVersion": "[variables('linuxFxVersion')]",
            "requestTracingEnabled": false,
            "remoteDebuggingEnabled": false,
            "remoteDebuggingVersion": "VS2019",
            "httpLoggingEnabled": false,
            "logsDirectorySizeLimit": 35,
            "detailedErrorLoggingEnabled": false,
            "publishingUsername": "[parameters('webAppName')]",
            "azureStorageAccounts": {},
            "scmType": "VSTSRM",
            "use32BitWorkerProcess": true,
            "webSocketsEnabled": false,
            "alwaysOn": true,
            "managedPipelineMode": "Integrated",
            "virtualApplications": [
                {
                    "virtualPath": "/",
                    "physicalPath": "site\\wwwroot",
                    "preloadEnabled": true
                }
            ],
            "loadBalancing": "LeastRequests",
            "experiments": {
                "rampUpRules": []
            },
            "autoHealEnabled": false,
            "localMySqlEnabled": false,
            "ipSecurityRestrictions": [
                {
                    "ipAddress": "Any",
                    "action": "Allow",
                    "priority": 1,
                    "name": "Allow all",
                    "description": "Allow all access"
                }
            ],
            "scmIpSecurityRestrictions": [
                {
                    "ipAddress": "Any",
                    "action": "Allow",
                    "priority": 1,
                    "name": "Allow all",
                    "description": "Allow all access"
                }
            ],
            "scmIpSecurityRestrictionsUseMain": false,
            "http20Enabled": false,
            "minTlsVersion": "1.2",
            "ftpsState": "Disabled",
            "reservedInstanceCount": 0
        }
    },
    {
        "type": "Microsoft.Web/sites/hostNameBindings",
        "apiVersion": "2018-02-01",
        "name": "[concat(parameters('webAppName'), '/', parameters('webAppName'), '.azurewebsites.net')]",
        "location": "[variables('locationName')]",
        "dependsOn": [
            "[resourceId('Microsoft.Web/sites', parameters('webAppName'))]"
        ],
        "properties": {
            "siteName": "[parameters('webAppName')]",
            "hostNameType": "Verified"
        }
    },
    {
      "type": "Microsoft.DevOps/pipelines",
      "apiVersion": "2019-07-01-preview",
      "name": "Clevva-CICD",
      "location": "[variables('locationName')]",
      "properties": {
        "organization": {
          "name": "ClevvaAzure"
        },
        "project": {
          "name": "Clevva App"
        },
        "bootstrapConfiguration": {
          "repository": {
            "repositoryType": "vstsGit",
            "id": "clevva-compiled",
            "defaultBranch": "master",
            "authorization": {
              "authorizationType": "personalAccessToken",
              "parameters": {}
            },
            "properties": {}
          },
          "template": {
            "id": "clevva.clevva-compiled",
            "parameters": {}
          }
        }
      }
    }
  ]
}